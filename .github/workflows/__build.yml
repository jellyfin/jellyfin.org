name: Build

on:
  workflow_call:
    inputs:
      ref:
        required: true
        type: string
      upload-pages-artifact:
        required: false
        type: boolean
        default: false

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ inputs.ref }}
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 20
      - name: Configure Pages
        if: inputs.upload-pages-artifact
        uses: actions/configure-pages@983d7736d9b0ae728b81ab479565c72886d7745b # v5.0.0
      - name: Run build
        run: |
          npm ci --no-audit
          npm run build
      - name: Upload artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: jellyfin-org__build
          path: build
      # Manual artifact creation because upload-pages-artifact v4 excludes dotfiles
      # https://github.com/actions/upload-pages-artifact/issues/129
      - name: Create pages artifact
        if: inputs.upload-pages-artifact
        run: tar --dereference --hard-dereference --directory build -cvf "$RUNNER_TEMP/artifact.tar" --exclude=.git --exclude=.github .
      - name: Upload pages artifact
        if: inputs.upload-pages-artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: github-pages
          path: ${{ runner.temp }}/artifact.tar
          retention-days: 1
